# 監査対策ドキュメント

このドキュメントでは、出退勤管理システムの監査対策について説明します。

## 監査ログの概要

監査ログは、システム内で発生した重要な操作を記録し、後から追跡・確認できるようにするためのものです。監査目的で必要な情報を包括的に記録しています。

## 記録対象の操作

以下の操作が監査ログに記録されます：

### 1. 時間記録の操作

- **CHECK_IN**: 出勤記録
- **CHECK_OUT**: 退勤記録
- **BREAK_START**: 休憩開始記録
- **BREAK_END**: 休憩終了記録

### 2. 管理者操作

- **USER_ROLE_UPDATED**: ユーザーの権限（ロール）変更

### 3. 将来的に追加予定の操作

- 時間記録の修正・削除
- ユーザー情報の変更
- その他の管理操作

## 監査ログに記録される情報

各監査ログには以下の情報が記録されます：

- **ID**: ログの一意識別子
- **userId**: 操作を行ったユーザーのID（時間記録操作の場合）
- **adminId**: 操作を行った管理者のID（管理者操作の場合）
- **action**: 操作内容（上記の操作タイプ）
- **resourceType**: 操作対象のリソースタイプ（例: "TimeEntry", "User"）
- **resourceId**: 操作対象のリソースID
- **details**: 操作の詳細情報（JSON形式）
  - 時間記録の場合: 記録タイプとタイムスタンプ
  - 権限変更の場合: 変更前後の権限
- **ipAddress**: 操作を行ったIPアドレス
- **userAgent**: 操作を行ったユーザーエージェント（ブラウザ情報）
- **createdAt**: 操作が実行された日時

## データ保持方針

### 監査ログの保持期間

- **推奨保持期間**: 少なくとも3年間
- **法的要件に応じた保持**: 管轄地域の法的要件に応じて調整が必要な場合があります

### データ保持の実装

現在の実装では、監査ログは自動削除されません。保持期間を超えたログを削除する場合は、手動でデータベースから削除する必要があります。

将来的には、定期実行されるバッチ処理を追加し、一定期間経過したログを自動的にアーカイブまたは削除する機能を実装することを検討しています。

## アクセス権限

### 監査ログの閲覧

- **管理者のみ**: 監査ログは管理者（`role: ADMIN`）のみが閲覧可能です
- **APIエンドポイント**: `/api/admin/audit-logs`
- **フロントエンド**: 管理者画面の「監査ログ」タブ

### 監査ログの変更・削除

- 監査ログは不変（immutable）であるべきです
- 現在の実装では、監査ログを変更・削除するAPIは提供していません
- 必要に応じて、管理者権限を持った特別なアカウントのみが削除権限を持つ機能を追加することを検討しています

## セキュリティ対策

### 1. データ整合性

- 監査ログはデータベーストランザクション内で記録されます
- 監査ログの記録に失敗した場合でも、元の操作はロールバックされません（システムの可用性を優先）
- ただし、監査ログの記録失敗はログファイルに記録されます

### 2. 不正操作の防止

- 状態遷移のバリデーション: 不正な状態遷移（例: 退勤後に出勤する）を防止
- 権限チェック: 管理者操作は管理者権限が必要
- セッション管理: セッションベースの認証により、不正なアクセスを防止

### 3. ログの改ざん防止

- 監査ログは作成後に変更できない設計
- データベースレベルでの権限制御
- 定期的なバックアップの推奨

## 監査ログのクエリ例

### 特定ユーザーの操作履歴

```typescript
GET /api/admin/audit-logs?userId=<user-id>
```

### 特定の操作タイプのログ

```typescript
GET /api/admin/audit-logs?action=CHECK_IN
```

### 期間を指定したログ

```typescript
GET /api/admin/audit-logs?startDate=2024-01-01&endDate=2024-12-31
```

## コンプライアンスへの対応

### 一般的な要件

1. **完全性**: すべての重要な操作が記録されている
2. **真正性**: ログが改ざんされていない
3. **可用性**: 必要な時にログを参照できる
4. **証跡**: 誰が、いつ、何を、どのように行ったかが記録されている

### 推奨事項

- 定期的な監査ログのレビュー
- 異常な操作パターンの検出
- ログのバックアップとアーカイブ
- ログ分析ツールの導入（将来的な拡張）

## 今後の拡張予定

1. **ログの自動アーカイブ**: 一定期間経過後のログを自動的にアーカイブ
2. **ログのエクスポート**: CSV/JSON形式でのエクスポート機能
3. **ログ分析機能**: 異常検知や統計情報の表示
4. **ログの暗号化**: 機密情報を含むログの暗号化（必要に応じて）

## 問い合わせ

監査に関する質問や要望がある場合は、システム管理者にお問い合わせください。

